version: '3.8'

services:
  # ===================
  # Databases
  # ===================
  postgres:
    image: pgvector/pgvector:16-bookworm
    container_name: ippoc-db
    environment:
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ippoc_hidb
    volumes:
      - postgres_prod_data:/var/lib/postgresql/data
      - ../memory/migrations:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    container_name: ippoc-cache
    command: redis-server --appendonly yes
    volumes:
      - redis_prod_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # ===================
  # Core IPPOC Node (Body)
  # ===================
  ippoc-node:
    build:
      context: ..
      dockerfile: Dockerfile
    container_name: ippoc-node
    environment:
      DATABASE_URL: postgresql://postgres:${POSTGRES_PASSWORD:-ippoc_secret}@postgres:5432/ippoc_hidb
      REDIS_URL: redis://redis:6379
      NODE_PORT: "9000"
      NODE_ROLE: ${NODE_ROLE:-reasoning}
      RUST_LOG: info
      ENABLE_SELF_EVOLUTION: "true"
      ENABLE_TOOLSMITH: "true"
    ports:
      - "9000:9000"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped

  # ===================
  # Memory Service (HiDB)
  # ===================
  memory:
    build:
      context: ..
      dockerfile: memory/api/Dockerfile
    container_name: ippoc-memory
    environment:
      DATABASE_URL: postgresql://postgres:${POSTGRES_PASSWORD:-ippoc_secret}@postgres:5432/ippoc_hidb
      REDIS_URL: redis://redis:6379
      GOOGLE_API_KEY: ${GOOGLE_API_KEY}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped

  # ===================
  # Cortex Service (Brain)
  # ===================
  cortex:
    build:
      context: ..
      dockerfile: brain/cortex/Dockerfile
    container_name: ippoc-cortex
    environment:
      MEMORY_URL: http://memory:8000
      BODY_URL: http://ippoc-node:9000
      ORCHESTRATOR_REDIS_URL: redis://redis:6379
      GOOGLE_API_KEY: ${GOOGLE_API_KEY}
    depends_on:
      - memory
      - ippoc-node
    restart: unless-stopped

  cortex-worker:
    build:
      context: ..
      dockerfile: brain/cortex/Dockerfile
    container_name: ippoc-cortex-worker
    environment:
      MEMORY_URL: http://memory:8000
      BODY_URL: http://ippoc-node:9000
      ORCHESTRATOR_REDIS_URL: redis://redis:6379
      ORCHESTRATOR_WORKER: "true"
      GOOGLE_API_KEY: ${GOOGLE_API_KEY}
    depends_on:
      - memory
      - ippoc-node
      - redis
    restart: unless-stopped

  # ===================
  # OpenClaw Cortex (Mind)
  # ===================
  openclaw-cortex:
    build:
      context: ../brain/cortex/openclaw-cortex
      dockerfile: Dockerfile
    container_name: ippoc-mind
    environment:
      DATABASE_URL: postgresql://postgres:${POSTGRES_PASSWORD:-ippoc_secret}@postgres:5432/ippoc_hidb
      REDIS_URL: redis://redis:6379
      NODE_HOST: ippoc-node
      NODE_PORT: "9000"
      VLLM_ENDPOINT: http://ippoc-node:9000/v1
      IPPOC_ORCHESTRATOR_MODE: http
      IPPOC_BRAIN_URL: http://cortex:8001
      ENABLE_SELF_EVOLUTION: "true"
      ENABLE_TOOLSMITH: "true"
      ENABLE_ECONOMY: "true"
      ENABLE_HARDENING: "true"
    ports:
      - "3000:3000"
    depends_on:
      - ippoc-node
      - memory
      - cortex
    restart: unless-stopped

  # ===================
  # Reverse Proxy (Security)
  # ===================
  gateway:
    image: nginx:alpine
    container_name: ippoc-gateway
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    ports:
      - "80:80"
      - "443:443"
    depends_on:
      - openclaw-cortex
    restart: unless-stopped

volumes:
  postgres_prod_data:
  redis_prod_data:
